var default_zooma_url="http://www.ebi.ac.uk/spot/zooma/",default_zooma_base_path="v2/api/services",default_logging_div="zooma-log",default_ols_search_end="http://www.ebi.ac.uk/ols/beta/api/terms?short_form=",default_tooltip_template='<div class="zooma-popup">\n	<header class="popup-header">\n		<h3>{{term}}</h3>\n		{{#isUserTerm}}\n			<h5>Term provided by <span class="confidence-label {{#lower}}{{confidence}}{{/lower}}-confidence-label">{{confidence}}</span></h5>\n		{{/isUserTerm}}\n		{{^isUserTerm}}\n			<h5>Term suggested by ZOOMA with <span class="confidence-label {{#lower}}{{confidence}}{{/lower}}-confidence-label">{{confidence}}</span> confidence</h5>\n		{{/isUserTerm}}\n	</header>\n	<section class="popup-body">\n		<h3>Description:</h3>\n		{{#excerpt}}\n			{{#description}}\n				<p>{{.}}</p>\n			{{/description}}\n		{{/excerpt}}\n	</section>\n	<footer class="popup-footer">\n		<a href="{{{iri}}}" target="_blank">{{{iri}}}</a>	\n	</footer>\n</div>';!function(e,t){var n,o,a,i={initOptions:function(e,t){var n=r(t);return l(n),u(n),n},autocomplete:function(e,t){var n=i.initOptions(e,t);return k(e,n)},annotate:function(e,t){var n=i.initOptions(e,t);return O(e,n)}},r=function(t){var n=e.extend({zooma_url:default_zooma_url,zooma_base_path:default_zooma_base_path},t);return e.extend({zooma_suggest_path:n.zooma_url+n.zooma_base_path+"/suggest",zooma_annotate_path:n.zooma_url+n.zooma_base_path+"/annotate",logging:"none",loggingDiv:default_logging_div,tooltipOrigin:"default"},n)},s=function(){return e("<span>").attr("class","zooma-spinner").append(e("<div>").addClass("throbber-loader"))},c=function(){return e("<button class='btn-custom-term'>Use custom term</button>")},l=function(t){if("console"!=t.logging&&"div"!=t.logging&&"none"!=t.logging)throw"logging option must be one of 'console', 'div' or 'none'";n=t.logging,"div"==n&&(o=e("#"+t.loggingDiv))},u=function(n){if("default"==n.tooltipOrigin)a=default_tooltip_template;else try{e.get(n.tooltipOrigin,function(e){a=e})}catch(o){d("Something went wrong!\nUnable to use "+n.tooltipOrigin+" as custom template.\nRelying on the default template"),a=default_tooltip_template}t.parse(a)},d=function(t){if("console"==n)try{console.log(t)}catch(a){console.log("Failed to log ("+a+")")}if("div"==n)try{0===o.length&&(e("body").append('<div id="zooma-log" />'),e("#zooma-log").hide()),o.append('<div class="logmessage">'+t+"</div>")}catch(a){o.append("Failed to log ("+a+")")}},p=function(e,t){switch(t=t.slice(0,1).toUpperCase()+t.slice(1).toLowerCase()){case"Array":case"Function":case"Object":case"String":case"Number":case"Date":break;default:return!1}var n={},o="[object "+t+"]";return e&&n.toString.call(e)===o},f=function(e){return p(e,"Function")},h=function(e){return p(e,"Array")},g=function(e){return p(e,"String")},m=function(t){try{var n=e(t);return d(t+" is a valid jQuery selector (selects "+n+")"),!0}catch(o){return d(o),!1}},v=function(e,t){return e.bind("keypress",function(e){13==e.keyCode&&t.apply(this,[e])})},b=function(e,t){return e.bind("keyup",function(e){27==e.keyCode&&t.apply(this,[e])})},_=function(e,t){function n(e,t){return e.length>t?e.slice(0,t)+"...":e}var o=e;if("undefined"!=typeof e&&null!==e)if(("undefined"==typeof t||null===t)&&(t=300),h(e))for(var a=0;a<e.length;a++)o.push(n(e[a],t));else g(e)&&(o=n(e,t));return o},y=function(n,o){var i=default_ols_search_end+o.shortname;n.tooltipster({content:"Loading...",contentAsHTML:!0,interactive:!0,maxWidth:400,trigger:"hover",theme:"tooltipster-light",functionBefore:function(n,r){r(),"cached"!==n.data("ajax")&&e.ajax({type:"GET",url:i,success:function(e){var i=e._embedded.terms[0],r={};r.term=i.label,r.confidence=o.confidence,r.description=i.description,r.iri=i.iri,r.isUserTerm="USER"===o.confidence,r.lower=function(){return function(e,t){return t(e).toLowerCase()}},r.excerpt=function(){return function(e,t){return _(t(e),400)+"</p>"}};var s=t.render(a,r);n.tooltipster("content",s).data("ajax","cached")},error:function(e){"USER"===o.confidence?n.tooltipster("content","No informations for this custom term").data("ajax","cached"):n.tooltipster("content","Error retrieving content").data("ajax","cached")}})}})},z=function(e,t,n){d("Retrieving zooma suggested terms for "+n),t.siblings(".zooma-annotations-container").show(),t.tagsinput("removeAll"),t.siblings().find(".zooma-spinner").show(),t.find(".zooma-spinner").show(),jQuery.getJSON(e.zooma_annotate_path+"?propertyValue="+encodeURI(n),function(e){w(t,e)})},w=function(t,n){t.siblings().find(".zooma-spinner").hide(),t.tagsinput("removeAll"),e(n).each(function(n,o){var a=[];if(e(o.semanticTags).each(function(e,t){var n=t.split("/"),o=n[n.length-1].split("#"),i=o[o.length-1];a.push(i)}),a.length>1){for(var i="",r=0;r<a.length-1;r++)i=i+a[r]+" & ";i+=a[length-1],o.shortname=i}else a.length>0?o.shortname=a[0]:o.shortname="Unknown";t.tagsinput("add",o)})},k=function(t,n){d("Adding zooma autocomplete functionality to "+t.attr("id")+" with configuration: "+JSON.stringify(n));var o=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:n.zooma_suggest_path+"?prefix=%QUERY",wildcard:"%QUERY"}});d("Binding typeahead to "+t.attr("id")+"..."),t.typeahead({hint:!0,highlight:!0,minLength:3},{source:o}),d("Typeahead bound ok!");var a=e('<div class="zooma-autocomplete-container"></div>');return t.parent().wrap(a),a},O=function(t,n){d("Adding zooma annotation functionality to "+t.attr("id")+" with configuration: "+JSON.stringify(n)),t.attr("data-role","tagsinput"),t.tagsinput({trimValue:!0,itemValue:"shortname",itemText:"shortname",freeInput:!0,confirmKeys:[],tagClass:function(e){var t=["tooltip","label"];switch(e.confidence){case"HIGH":t.push("high-confidence-label");break;case"GOOD":t.push("good-confidence-label");break;case"MEDIUM":t.push("medium-confidence-label");break;case"LOW":t.push("low-confidence-label");break;case"USER":t.push("user-confidence-label");break;default:t.push("default-label")}return t.join(" ")}}),d("Setup tagsinput on "+t.attr("id")+" ok!");var o,a=n.annotation_source;f(a)?(o=a.apply(this,[]),z(n,t,o)):a.is("input")?v(e(a),function(){d("Detected enter pressed on "+a.attr("id"));var e=a.val();z(n,t,e)}):m(a)?z(n,t,e(a)):z(n,t,a),d("Annotation detection bound ok!");var i=t.siblings(".bootstrap-tagsinput");i.addClass("zooma-annotations-container");var r=s();r.prependTo(i),r.hide();var l=t.tagsinput("input");l.attr("data-role","custom-term-input"),v(l,function(e){var n={};n.shortname=l.val(),n.confidence="USER",t.tagsinput("add",n),l.val(""),l.hide()}),b(l,function(e){l.val(""),l.hide()}),l.val(""),l.hide();var u=c();return u.appendTo(i),u.on("click",function(e){l.show()}),i.hide(),d("Setup annotation added event binding"),t.on("itemAdded",function(e){var t=e.item.shortname,n=i.find("span.tag:contains('"+t+"')");n.attr("data-shortcode",t),y(n,e.item)}),d("Event annotation added bound ok"),i},U=function(t,n){var o=i.initOptions(t,n);d("Attempting to set up unified zooma widget from "+t.attr("id")+"...");var a,r;if(t.is("input")){a=e('<select class="zooma-tags" multiple style="display: none"></select>'),t.after(a);var s=k(t,o);r=e.extend({annotation_source:t},o);var c=(O(a,r),e('<div class="zooma-container"></div>'));return s.wrap(c),c}if(t.is("div")){t.append("Search:");var l=e('<input type="text" class="zooma-input" />');return t.append(l),a=e('<select class="zooma-tags" multiple style="display: none"></select>'),t.append(a),k(l,o),r=e.extend({annotation_source:l},o),O(a,r),t.addClass("zooma-container"),t}throw"Zooma target must be either <input> or <div> element"};e.fn.zooma=function(t,n){if(i[t])return this.each(function(){return i[t].apply(this,[e(this),n])});try{return U(e(this),t)}catch(o){e.error("Invalid usage: jQuery.zooma plugin does not support the command '"+t+"' and this is not an options object either")}}}(jQuery,Mustache);